{% extends "/base.html" %}
{% import "/_macros.html" as macros %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Forum{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<div class="container navbar-default" style="height:100%;padding-top:30px;">
    <div class="container">
        <div style="padding-top: 60px">
        {{ wtf.quick_form(form) }}
        </div>
        {% for each in posts %}
        <div id="block{{ each.id }}" style="padding-top:60px;padding-bottom:30px">
            <div class="media-left">
                <a href="{{ url_for('main.user', email=each.author.email) }}"><img src="{{ url_for('static', filename=('headicon/'+each.author.headicon_url)) }}" class="media-object" style="width:55px"></a>
            </div>
            <div class="media-body">
                <a href="{{ url_for('main.user', email=each.author.email) }}"><h5 class="media-heading">{{ each.author.nickname }}</h5></a>
                {% if each.body_html %}
                {{ each.body_html | safe }}
                {% else %}
                {{ each.body }}
                {% endif %}
                <p>{{ each.timestamp }}</p>

            </div>
            <div id="like{{ each.id }}"  type="button" class="heart0 btn btn-default btn-sm col-xs-6" style="outline:none;height:30px">
                {% if not each.is_liked(current_user) %}
                <div class="heart " id="icon{{ each.id }}" rel="like" style="margin-top:-16px;"></div>
                {% else %}
                <div class="heart unlike" id="icon{{ each.id }}" rel="unlike" style="margin-top:-16px;"></div>
                {% endif %}
                <div class="likeCount" id="likeCount{{each.id}}">{{each.liked_count}}</div>
            </div>
            <button id="comments{{ each.id }}" onclick="comments(id)" type="button" class="comments btn btn-default btn-sm col-xs-6" style="outline:none;">comment</button>
            <div id="spread{{ each.id }}"style="display: none;">
                <!-- comments-->

                <div class="container" style="padding-top:30px">
                    <div class="media-left">
                        <a href="{{ url_for('main.user', email=each.author.email) }}"><img src="{{ url_for('static', filename=('headicon/'+each.author.headicon_url)) }}" class="media-object" style="width:55px"></a>
                    </div>
                    <div class="media-body">
                        <a href="{{ url_for('main.user', email=each.author.email) }}"><h5 class="media-heading">{{ each.author.nickname }}</h5></a>
                        {% if each.body_html %}
                        {{ each.body_html | safe }}
                        {% else %}
                        {{ each.body }}
                        {% endif %}
                        <p>{{ each.timestamp }}</p>

                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="pagination" style="margin-left:37%">
        {{ macros.pagination_widget(pagination, 'forum.index') }}
    </div>
</div>
{% endblock %}
<script src="../js/jquery-1.11.0.min.js" type="text/javascript"></script>
{% block scripts %}

<script type="text/javascript">

    function like(id) {
        var post_id = id.substr(4);
        $.ajax({
            url: "../../api/posts/like",
            type: "POST",
            dataType: "json",
            data: {"post_id": post_id, "user_id": {{ current_user.id }}},
        });
    }

    function comments(id) {
        var get_id = id.substr(8);
        var value;
        $.ajax({
            url: "../../api/posts/comments",
            type: "GET",
            dataType: "json",
            data: { "id": get_id, "page": 1 },
            {#success: function (data) {
                alert(JSON.stringify(data));
                value = JSON.stringify(data);
                var obj = JSON.parse(value);
                alert(obj.count);
            }#}
        });
    }
    $(document).ready(function()
    {
        var textarea=document.getElementById('content');
        //设置高度
        textarea.style.height = textarea.scrollHeight + 'px';

        $('body').on("click",'.heart0',function()
        {
	        var A=$(this).attr("id");
	        var B=A.split("like");
	        var messageID=B[1];
	        var C=parseInt($("#likeCount"+messageID).html());
	        $("#icon"+messageID).css("background-position","")
	        var D=$("#icon"+messageID).attr("rel");

	        if(D === 'like')
	        {
	            $("#likeCount"+messageID).html(C+1);
                $("#icon" + messageID).addClass("heartAnimation").attr("rel", "unlike");
                like("like" + messageID);
	        }
	        else
	        {
	            $("#likeCount"+messageID).html(C-1);
	            $("#icon"+messageID).removeClass("heartAnimation").attr("rel","like");
                $("#icon" + messageID).css("background-position", "left");
                like("like" + messageID);
	        }
        });

        $('body').on("click", '.comments', function () {
            var A = $(this).attr("id");
            var B = A.split("comments");
            var messageID = B[1];
            res = comments("comments"+messageID);
            var div = `<div class="container" style="padding-top:30px">
                    <div class="media-left">
                        <a href="#"></a>
                    </div>
                    <div class="media-body">
                      <p>123321</p>
                    </div>
                </div>`;
            $("#block"+messageID).append(div);

            //$("#spread" + messageID).slideToggle();
            res = comments("comments"+messageID);
        });

    });

    $(document).ready(function ()
    {
       
        $(".unlike").css("background-position","right");
        
    });
</script>
{% endblock %}
